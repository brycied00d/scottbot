var brain=(function(){var a={};e=a;var b=function(a){var a=a||{},b=a.name||Math.floor(Math.random()*1e5);this.prefix="brain.bayesian."+b,a.testing&&(localStorage={})};b.prototype={async:false,getCats:function(){return JSON.parse(localStorage[this.prefix+".cats"]||"{}")},setCats:function(a){localStorage[this.prefix+".cats"]=JSON.stringify(a)},getWordCount:function(a){return JSON.parse(localStorage[this.prefix+".words."+a]||"{}")},setWordCount:function(a,b){localStorage[this.prefix+".words."+a]=JSON.stringify(b)},getWordCounts:function(a){var b={};a.forEach(function(a){b[a]=this.getWordCount(a)},this);return b},incCounts:function(a,b){var c=this.getCats();_(a).each(function(a,b){c[b]=c[b]+a||a},this),this.setCats(c),_(b).each(function(a,b){var c=this.getWordCount(b);_(a).each(function(a,b){c[b]=c[b]+a||a},this),this.setWordCount(b,c)},this)}},a.LocalStorageBackend=b,e=a;var c=function(){this.catCounts={},this.wordCounts={}};c.prototype={async:false,incCounts:function(a,b){_(a).each(function(a,b){this.catCounts[b]=this.catCounts[b]+a||a},this),_(b).each(function(a,b){this.wordCounts[b]=this.wordCounts[b]||{},_(a).each(function(a,c){this.wordCounts[b][c]=this.wordCounts[b][c]+a||a},this)},this)},getCats:function(){return this.catCounts},getWordCounts:function(a,b){return this.wordCounts}},a.MemoryBackend=c;var d=a,e=a,f=function(a){a=a||{};var b=a.port||6379,c=a.hostname||"localhost",e=a.options||{};this.client=function(){return d.createClient(b,c,e)};var f=a.name||Math.floor(Math.random()*1e5);this.catsKey="brain_bayes_cats_"+f,this.wordsKey="brain_bayes_words_"+f,a.db&&this.client().select(a.db)};f.prototype={async:true,key:function(a,b){return a+"____"+b},pair:function(a){return/(.*)____(.*)/.exec(a).slice(1)},incCounts:function(a,b,c){var d=this.client();d.multi(),_(a).each(function(a,b){d.hincrby(this.catsKey,b,a)},this),_(b).each(function(a,b){_(a).each(function(a,c){d.hincrby(this.wordsKey,this.key(b,c),a)},this)},this);var e=this;d.exec(function(a,b){d.close(),c(b)})},getCats:function(a){var b=this,c=this.client();c.hgetall(this.catsKey,function(b,d){_(d).each(function(a,b){d[b]=parseInt(a)}),c.close(),a(d)})},getWordCounts:function(a,b,c){var d=_(a).reduce(function(a,c){return a.concat(_(b).map(function(a,b){return this.key(c,b)},this))},[],this),e=this,f=[this.wordsKey].concat(d);f.push(function(a,b){var f={};d.map(function(a,c){var d=e.pair(a),g=d[0],h=d[1];f[g]=f[g]?f[g]:{},f[g][h]=parseInt(b[c])||0},this),g.close(),c(f)});var g=this.client();g.hmget.apply(g,f)}},a.RedisBackend=f,e=a;var g=function(b){b=b||{},this.thresholds=b.thresholds||{},this.def=b.def||"unclassified",this.weight=b.weight||1,this.assumed=b.assumed||0.5;var c=b.backend||{type:"memory"};switch(c.type.toLowerCase()){case"redis":this.backend=new a.RedisBackend(c.options);break;case"localstorage":this.backend=new a.LocalStorageBackend(c.options);break;default:this.backend=new a.MemoryBackend}};g.prototype={getCats:function(a){return this.backend.getCats(a)},getWordCounts:function(a,b,c){return this.backend.getWordCounts(a,b,c)},incDocCounts:function(a,b){var c={},d={};a.forEach(function(a){var b=a.cat;d[b]=d[b]?d[b]+1:1;var e=this.getWords(a.doc);e.forEach(function(a){c[a]=c[a]||{},c[a][b]=c[a][b]?c[a][b]+1:1},this)},this);return this.backend.incCounts(d,c,b)},setThresholds:function(a){this.thresholds=a},getWords:function(a){if(_(a).isArray())return a;var b=a.split(/\W+/);return _(b).uniq()},train:function(a,b,c){this.incDocCounts([{doc:a,cat:b}],function(a,b){c(b)})},trainAll:function(a,b){docs=a.map(function(a){return{doc:a.input,cat:a.output}}),this.incDocCounts(docs,function(a,c){b(c)})},wordProb:function(a,b,c,d){var e=(d[b]||0)/c[b],f=_(c).reduce(function(a,b,c){return a+(d[c]||0)},0,this);return(this.weight*this.assumed+f*e)/(this.weight+f)},getCatProbs:function(a,b,c){var d=_(a).reduce(function(a,b){return a+b},0),e={};_(a).each(function(f,g){var h=(f||0)/d,i=_(b).reduce(function(b,d){var e=c[d]||{};return b*this.wordProb(d,g,a,e)},1,this);e[g]=h*i},this);return e},getProbs:function(a,b){var c=this;this.getCats(function(d){var e=c.getWords(a);c.getWordCounts(e,d,function(a){var f=c.getCatProbs(d,e,a);b(f)})})},getProbsSync:function(a,b){var c=this.getWords(a),d=this.getCats(),e=this.getWordCounts(c,d);return this.getCatProbs(d,c,e)},bestMatch:function(a){var b=_(a).reduce(function(a,b,c){return a.prob>b?a:{cat:c,prob:b}},{prob:0}),c=b.cat,d=this.thresholds[b.cat]||1;_(a).map(function(a,e){!(e==b.cat)&&a*d>b.prob&&(c=this.def)},this);return c},classify:function(a,b){if(!this.backend.async)return this.classifySync(a);var c=this;this.getProbs(a,function(a){b(c.bestMatch(a))})},classifySync:function(a){var b=this.getProbsSync(a);return this.bestMatch(b)},test:function(a){var b=0;a.forEach(function(a){var c=this.classify(a.input);b+=c==a.output?0:1},this);return b/a.length}},a.BayesianClassifier=g,a.NeuralNetwork=a.NeuralNetwork,a.crossValidate=a.crossValidate,a.BayesianClassifier=a.BayesianClassifier,e=a;function h(a,b,c,d){var e=new a(b),f=Date.now();e.trainAll(c);var g=Date.now(),h=e.test(d),i=Date.now();return{error:h,trainTime:g-f,testTime:i-g,trainSize:c.length,testSize:d.length}}a.crossValidate=function(a,b,c,d){var e=c.length/d,f=_.range(d).map(function(a){var b=_(c).clone();return[b.splice(a*e,e),b]}),g=_(f).map(function(c,d){return h(a,b,c[1],c[0])});return g};var i=function(a){this.learningRate=0.5,this.growthRate=0.5,a&&this.setOptions(a),this.createLayers(this.hidden)};i.prototype={setOptions:function(a){for(option in a)this[option]=a[option]},createLayers:function(a,b){var c=3;a?c=a.length+2:b&&(c=b.layers.length),this.layers=[];for(var d=0;d<c;d++){var e=a?a[d-1]:0,f=b?b.layers[d]:null,g=new j(this,g,e,f);this.layers.push(g)}this.inputLayer=this.layers[0],this.outputLayer=this.layers[c-1],!a&&!b?this.hiddenLayer=this.layers[1]:this.hiddenLayer=null},run:function(a){this.inputLayer.createNodes(a),this.hiddenLayer&&this.hiddenLayer.growLayer(this.inputLayer.getSize()),this.inputLayer.setOutputs(a);for(var b=1;b<this.layers.length;b++)this.layers[b].calcOutputs();var c=this.outputLayer.getOutputs();return this.formatOutput(c)},trainItem:function(a,b){this.outputLayer.createNodes(b),this.run(a),this.outputLayer.calcErrors(b);for(var c=this.layers.length-2;c>=0;c--)this.layers[c].calcErrors();for(var c=1;c<this.layers.length;c++)this.layers[c].adjustWeights();return this.outputLayer.getError()},train:function(a,b,c,d,e){b||(b=2e4),c||(c=5e-3);var f=1;for(var g=0;g<b&&f>c;g++){var h=0;for(var i=0;i<a.length;i++){var j=this.trainItem(a[i].input,a[i].output);h+=Math.pow(j,2)}f=Math.sqrt(h)/a.length,d&&g%e==0&&d({error:f,iterations:g})}return{error:f,iterations:g}},trainAll:function(a){this.train(a)},getError:function(a,b){var c=0,d=0;for(var e in a)c+=Math.pow(a[e]-b[e],2),d++;return c/d},test:function(a){var b=0;for(var c=0;c<a.length;c++){var d=this.run(a[c].input);b+=this.getError(d,a[c].output)}return b/a.length},formatOutput:function(a){var b=[];for(var c in a){if(parseInt(c)!=c)return a;b.push(a[c])}return b},toJSON:function(){var a={layers:[]};for(var b=0;b<this.layers.length;b++)a.layers.push(this.layers[b].toJSON());return a},fromJSON:function(a){this.createLayers(null,a);return this},toFunction:function(){var a=this.toJSON();return new Function("inputs","  var net = "+JSON.stringify(a)+";\n\n\n  for(var i = 1; i < net.layers.length; i++) {\n\n    var nodes = net.layers[i].nodes;\n\n    var outputs = {};\n\n    for(var id in nodes) {\n\n      var node = nodes[id];\n\n      var sum = node.bias;\n\n      for(var iid in node.weights)\n\n        sum += node.weights[iid] * inputs[iid];\n\n      outputs[id] = (1/(1 + Math.exp(-sum)));\n\n    }\n\n    inputs = outputs;\n\n  }\n\n  return outputs;")},toString:function(){return JSON.stringify(this.toJSON())}};function j(a,b,c,d){this.network=a,this.prevLayer=b,this.prevLayer&&(this.prevLayer.nextLayer=this),this.nodes={};if(d)this.fromJSON(d);else if(c)for(var e=0;e<c;e++)this.createNode(e)}j.prototype={getOutputs:function(){return this.map(function(a){return a.output})},setOutputs:function(a){this.map(function(b,c){b.output=a[c]||0})},getError:function(){var a=this.reduce(function(a,b){return a+Math.pow(b.error,2)},0);return Math.sqrt(a)/this.getSize()},getSize:function(){return this.reduce(function(a){return++a},0)},map:function(a){var b={};for(var c in this.nodes)b[c]=a(this.nodes[c],c);return b},reduce:function(a,b){for(var c in this.nodes)b=a(b,this.nodes[c]);return b},growLayer:function(a){var b=a;a>5&&(b*=this.network.growthRate);for(var c=this.getSize();c<b;c++)this.createNode(c)},createNodes:function(a){for(var b in a)this.nodes[b]||this.createNode(b)},createNode:function(a){var b=new k(this,a);this.nodes[a]=b;if(this.nextLayer){var c=this.nextLayer.nodes;for(var d in c)c[d].addIncoming(a)}},calcOutputs:function(){this.map(function(a){a.calcOutput()})},calcErrors:function(a){this.map(function(b){b.calcError(a)})},adjustWeights:function(){this.map(function(a){a.adjustWeights()})},toJSON:function(){var a={nodes:{}};for(var b in this.nodes)a.nodes[b]=this.nodes[b].toJSON();return a},fromJSON:function(a){this.nodes={};for(var b in a.nodes)this.nodes[b]=new k(this,b,a.nodes[b])}};function k(a,b,c){this.layer=a,this.id=b,this.output=0;if(c)this.fromJSON(c);else if(this.layer.prevLayer){this.weights={};for(var b in this.getIncoming())this.addIncoming(b);this.bias=this.randomWeight()}}k.prototype={getInputs:function(){return this.layer.prevLayer.getOutputs()},getIncoming:function(){return this.layer.prevLayer.nodes},getOutgoing:function(){return this.layer.nextLayer.nodes},randomWeight:function(){return Math.random()*0.4-0.2},sigmoid:function(a){return 1/(1+Math.exp(-a))},dsigmoid:function(a){return a*(1-a)},addIncoming:function(a){this.weights[a]=this.randomWeight()},calcOutput:function(){var a=this.bias;for(var b in this.weights)a+=this.weights[b]*this.getInputs()[b];this.output=this.sigmoid(a)},calcError:function(a){if(a){var b=a[this.id]||0;this.error=b-this.output}else{this.error=0;var c=this.getOutgoing();for(var d in c)this.error+=c[d].delta*c[d].weights[this.id]}this.delta=this.error*this.dsigmoid(this.output)},adjustWeights:function(){var a=this.layer.network.learningRate;for(var b in this.getInputs())this.weights[b]+=a*this.delta*this.getInputs()[b];this.bias+=a*this.delta},toJSON:function(){return{weights:this.weights,bias:this.bias}},fromJSON:function(a){this.weights=a.weights,this.bias=a.bias}},a.NeuralNetwork=i;return a})()